<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Planar</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect x='30' y='30' width='40' height='40' rx='6' fill='%23E8A44A' transform='rotate(45 50 50)'/></svg>">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #0C0F14;
  --bg-raised: #13161D;
  --bg-surface: #1A1E27;
  --bg-surface-2: #222733;
  --bg-hover: rgba(255,255,255,0.04);
  --bg-active: rgba(255,255,255,0.07);
  --accent: #E8A44A;
  --accent-hover: #D4922E;
  --accent-dim: rgba(232,164,74,0.12);
  --accent-glow: rgba(232,164,74,0.2);
  --text-primary: #E8E6E3;
  --text-secondary: #9B9A97;
  --text-tertiary: #5E5D5A;
  --border: rgba(255,255,255,0.06);
  --border-light: rgba(255,255,255,0.04);
  --border-accent: rgba(232,164,74,0.25);
  --success: #5CB87A;
  --success-dim: rgba(92,184,122,0.12);
  --warning: #E8A44A;
  --warning-dim: rgba(232,164,74,0.12);
  --error: #E06C75;
  --error-dim: rgba(224,108,117,0.12);
  --info: #61AFEF;
  --info-dim: rgba(97,175,239,0.12);
  --radius: 12px;
  --radius-sm: 8px;
  --radius-lg: 16px;
  --radius-xl: 20px;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.3);
  --shadow-md: 0 4px 16px rgba(0,0,0,0.4);
  --shadow-lg: 0 8px 32px rgba(0,0,0,0.5);
  --shadow-glow: 0 0 20px rgba(232,164,74,0.15);
  --font: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
  --font-mono: 'JetBrains Mono', 'SF Mono', monospace;
  --transition: 180ms cubic-bezier(0.4, 0, 0.2, 1);
  --transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);
}

html, body { height: 100%; }

body {
  font-family: var(--font);
  background: var(--bg);
  color: var(--text-primary);
  line-height: 1.55;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

::selection {
  background: var(--accent-dim);
  color: var(--accent);
}

/* ═══════════════ AUTH SCREEN ═══════════════ */
.auth-screen {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100vh;
  padding: 20px;
  background: var(--bg);
  background-image:
    radial-gradient(ellipse 80% 60% at 50% -20%, rgba(232,164,74,0.06) 0%, transparent 60%),
    radial-gradient(ellipse 50% 40% at 80% 100%, rgba(97,175,239,0.03) 0%, transparent 60%);
}

.auth-card {
  background: var(--bg-raised);
  border: 1px solid var(--border);
  border-radius: var(--radius-xl);
  padding: 48px 40px;
  width: 100%;
  max-width: 420px;
  box-shadow: var(--shadow-lg);
  animation: authFadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes authFadeIn {
  from { opacity: 0; transform: translateY(12px) scale(0.98); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}

.auth-logo {
  font-size: 28px;
  font-weight: 700;
  letter-spacing: -1px;
  color: var(--text-primary);
  margin-bottom: 4px;
}

.auth-logo::before {
  content: '';
  display: inline-block;
  width: 8px;
  height: 8px;
  background: var(--accent);
  border-radius: 2px;
  margin-right: 10px;
  vertical-align: middle;
  transform: rotate(45deg);
}

.auth-subtitle {
  color: var(--text-secondary);
  font-size: 14px;
  font-weight: 400;
  margin-bottom: 36px;
}

.form-group { margin-bottom: 20px; }

.form-group label {
  display: block;
  font-size: 12px;
  font-weight: 500;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.6px;
  margin-bottom: 8px;
}

input[type="text"],
input[type="password"],
input[type="number"],
textarea,
select {
  width: 100%;
  padding: 12px 16px;
  font-size: 14px;
  font-family: var(--font);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  background: var(--bg-surface);
  color: var(--text-primary);
  outline: none;
  transition: border-color var(--transition), box-shadow var(--transition);
}

input::placeholder, textarea::placeholder { color: var(--text-tertiary); }

input:focus, textarea:focus, select:focus {
  border-color: var(--border-accent);
  box-shadow: 0 0 0 3px var(--accent-dim);
}

textarea { resize: vertical; min-height: 80px; }

select {
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M1 1l5 5 5-5' fill='none' stroke='%239B9A97' stroke-width='1.5' stroke-linecap='round'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 14px center;
  padding-right: 36px;
}

.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 11px 22px;
  font-size: 13px;
  font-weight: 600;
  font-family: var(--font);
  border: none;
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: all var(--transition);
  text-decoration: none;
  letter-spacing: 0.2px;
}

.btn-primary {
  background: var(--accent);
  color: var(--bg);
}
.btn-primary:hover { background: var(--accent-hover); box-shadow: var(--shadow-glow); }
.btn-primary:active { transform: scale(0.98); }
.btn-primary:disabled { opacity: 0.4; cursor: not-allowed; box-shadow: none; }

.btn-secondary {
  background: var(--bg-surface);
  color: var(--text-secondary);
  border: 1px solid var(--border);
}
.btn-secondary:hover { background: var(--bg-surface-2); color: var(--text-primary); border-color: rgba(255,255,255,0.1); }

.btn-ghost {
  background: transparent;
  color: var(--text-secondary);
  padding: 8px 12px;
}
.btn-ghost:hover { background: var(--bg-hover); color: var(--text-primary); }

.btn-full { width: 100%; }

.auth-toggle {
  text-align: center;
  margin-top: 24px;
  font-size: 13px;
  color: var(--text-tertiary);
}
.auth-toggle a {
  color: var(--accent);
  cursor: pointer;
  text-decoration: none;
  font-weight: 500;
}
.auth-toggle a:hover { text-decoration: underline; }

.auth-error {
  background: var(--error-dim);
  color: var(--error);
  font-size: 13px;
  padding: 10px 14px;
  border-radius: var(--radius-sm);
  margin-bottom: 20px;
  display: none;
  border: 1px solid rgba(224,108,117,0.2);
}

/* ═══════════════ APP LAYOUT ═══════════════ */
.app {
  display: none;
  height: 100vh;
}
.app.active { display: flex; }

/* ═══════════════ SIDEBAR ═══════════════ */
.sidebar {
  width: 280px;
  min-width: 280px;
  background: var(--bg-raised);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  height: 100vh;
  position: relative;
}

.sidebar::after {
  content: '';
  position: absolute;
  top: 0;
  right: 0;
  bottom: 0;
  width: 1px;
  background: linear-gradient(to bottom, var(--accent-dim), transparent 30%, transparent 70%, var(--accent-dim));
  pointer-events: none;
}

.sidebar-header {
  padding: 24px 20px 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.sidebar-brand {
  font-size: 20px;
  font-weight: 700;
  letter-spacing: -0.5px;
  color: var(--text-primary);
}

.sidebar-brand::before {
  content: '';
  display: inline-block;
  width: 7px;
  height: 7px;
  background: var(--accent);
  border-radius: 2px;
  margin-right: 8px;
  transform: rotate(45deg);
  vertical-align: middle;
}

.sidebar-user {
  font-size: 12px;
  color: var(--text-tertiary);
  padding: 12px 20px;
  border-top: 1px solid var(--border);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-family: var(--font-mono);
}

.sidebar-user button {
  font-size: 11px;
  color: var(--text-tertiary);
  background: none;
  border: none;
  cursor: pointer;
  font-family: var(--font);
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  padding: 4px 8px;
  border-radius: 4px;
  transition: all var(--transition);
}
.sidebar-user button:hover { color: var(--error); background: var(--error-dim); }

.sidebar-section-title {
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1.2px;
  color: var(--text-tertiary);
  padding: 20px 20px 10px;
}

.project-list {
  flex: 1;
  overflow-y: auto;
  padding: 0 10px 10px;
}

.project-item {
  padding: 10px 14px;
  border-radius: var(--radius-sm);
  cursor: pointer;
  font-size: 14px;
  font-weight: 400;
  color: var(--text-secondary);
  transition: all var(--transition);
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 2px;
  position: relative;
}
.project-item:hover { background: var(--bg-hover); color: var(--text-primary); }
.project-item.active {
  background: var(--accent-dim);
  color: var(--accent);
  font-weight: 500;
}

.project-item .dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--text-tertiary);
  flex-shrink: 0;
  transition: all var(--transition);
}
.project-item.active .dot {
  background: var(--accent);
  box-shadow: 0 0 6px var(--accent-glow);
}

.new-project-btn {
  margin: 10px;
  padding: 10px;
  border: 1px dashed rgba(255,255,255,0.08);
  border-radius: var(--radius-sm);
  background: transparent;
  color: var(--text-tertiary);
  font-size: 13px;
  font-weight: 500;
  font-family: var(--font);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  transition: all var(--transition);
}
.new-project-btn:hover {
  border-color: var(--border-accent);
  color: var(--accent);
  background: var(--accent-dim);
}

/* ═══════════════ MAIN ═══════════════ */
.main {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  background: var(--bg);
}

.main-empty {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: var(--text-tertiary);
  font-size: 15px;
  gap: 8px;
}

.main-empty::before {
  content: '';
  width: 48px;
  height: 48px;
  border: 2px dashed var(--text-tertiary);
  border-radius: var(--radius);
  opacity: 0.3;
  margin-bottom: 8px;
}

.main-header {
  padding: 20px 32px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: var(--bg-raised);
}

.main-header h2 {
  font-size: 20px;
  font-weight: 600;
  letter-spacing: -0.3px;
}

.main-header .project-desc {
  font-size: 13px;
  color: var(--text-tertiary);
  margin-top: 3px;
}

/* ═══════════════ TABS ═══════════════ */
.tabs {
  display: flex;
  gap: 0;
  border-bottom: 1px solid var(--border);
  background: var(--bg-raised);
  padding: 0 32px;
}

.tab {
  padding: 14px 24px;
  font-size: 13px;
  font-weight: 500;
  color: var(--text-tertiary);
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all var(--transition);
  font-family: var(--font);
  background: none;
  border-top: none;
  border-left: none;
  border-right: none;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.tab:hover { color: var(--text-secondary); }
.tab.active {
  color: var(--accent);
  border-bottom-color: var(--accent);
}

.tab-content {
  flex: 1;
  overflow: hidden;
  display: none;
}
.tab-content.active { display: flex; flex-direction: column; }

/* ═══════════════ FILES ═══════════════ */
.files-area {
  flex: 1;
  overflow-y: auto;
  padding: 28px 32px;
}

.drop-zone {
  border: 1px dashed rgba(255,255,255,0.1);
  border-radius: var(--radius-lg);
  padding: 48px 24px;
  text-align: center;
  transition: all var(--transition-slow);
  margin-bottom: 28px;
  cursor: pointer;
  background: var(--bg-raised);
  position: relative;
  overflow: hidden;
}

.drop-zone::before {
  content: '';
  position: absolute;
  inset: 0;
  background: radial-gradient(ellipse at center, var(--accent-dim) 0%, transparent 70%);
  opacity: 0;
  transition: opacity var(--transition-slow);
}

.drop-zone:hover::before, .drop-zone.drag-over::before { opacity: 1; }

.drop-zone:hover, .drop-zone.drag-over {
  border-color: var(--border-accent);
}

.drop-zone-icon {
  font-size: 36px;
  margin-bottom: 12px;
  opacity: 0.25;
  position: relative;
}

.drop-zone-text {
  font-size: 14px;
  color: var(--text-secondary);
  position: relative;
}
.drop-zone-text strong { color: var(--accent); font-weight: 600; }

.drop-zone-hint {
  font-size: 12px;
  color: var(--text-tertiary);
  margin-top: 6px;
  font-family: var(--font-mono);
  letter-spacing: 0.3px;
  position: relative;
}

.file-list { display: flex; flex-direction: column; gap: 6px; }

.file-item {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 14px 18px;
  background: var(--bg-raised);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  transition: all var(--transition);
}
.file-item:hover { border-color: rgba(255,255,255,0.08); background: var(--bg-surface); }

.file-icon {
  width: 40px;
  height: 40px;
  border-radius: var(--radius-sm);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  font-weight: 600;
  flex-shrink: 0;
  text-transform: uppercase;
  font-family: var(--font-mono);
  letter-spacing: 0.5px;
}
.file-icon.pdf { background: var(--error-dim); color: var(--error); }
.file-icon.pptx { background: var(--warning-dim); color: var(--accent); }
.file-icon.xlsx { background: var(--success-dim); color: var(--success); }
.file-icon.docx { background: var(--info-dim); color: var(--info); }
.file-icon.csv { background: rgba(171,130,239,0.12); color: #AB82EF; }
.file-icon.txt { background: rgba(255,255,255,0.05); color: var(--text-secondary); }

.file-info { flex: 1; min-width: 0; }
.file-name {
  font-size: 14px;
  font-weight: 500;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.file-meta {
  font-size: 11px;
  color: var(--text-tertiary);
  display: flex;
  gap: 12px;
  margin-top: 2px;
  font-family: var(--font-mono);
}

.file-status {
  font-size: 11px;
  font-weight: 600;
  padding: 4px 10px;
  border-radius: 20px;
  flex-shrink: 0;
  font-family: var(--font-mono);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.file-status.pending { background: var(--warning-dim); color: var(--warning); }
.file-status.processing { background: var(--info-dim); color: var(--info); }
.file-status.ready { background: var(--success-dim); color: var(--success); }
.file-status.error { background: var(--error-dim); color: var(--error); }

.file-delete {
  background: none;
  border: none;
  color: var(--text-tertiary);
  cursor: pointer;
  padding: 6px;
  border-radius: 6px;
  font-size: 18px;
  line-height: 1;
  transition: all var(--transition);
  opacity: 0;
}
.file-item:hover .file-delete { opacity: 1; }
.file-delete:hover { color: var(--error); background: var(--error-dim); }

/* ═══════════════ CHAT ═══════════════ */
.chat-area {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.chat-controls {
  padding: 14px 32px;
  display: flex;
  align-items: center;
  gap: 10px;
  border-bottom: 1px solid var(--border);
  background: var(--bg-raised);
}

.chat-select {
  flex: 1;
  padding: 9px 14px;
  font-size: 13px;
}

.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 28px 32px;
  display: flex;
  flex-direction: column;
  gap: 20px;
  background-image: radial-gradient(ellipse 100% 100% at 50% 0%, rgba(232,164,74,0.02) 0%, transparent 50%);
}

.msg {
  max-width: 720px;
  padding: 16px 20px;
  border-radius: var(--radius-lg);
  font-size: 14px;
  line-height: 1.7;
  word-wrap: break-word;
  white-space: pre-wrap;
  animation: msgIn 0.25s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes msgIn {
  from { opacity: 0; transform: translateY(6px); }
  to { opacity: 1; transform: translateY(0); }
}

.msg.user {
  align-self: flex-end;
  background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
  color: var(--bg);
  border-bottom-right-radius: 4px;
  font-weight: 450;
}

.msg.assistant {
  align-self: flex-start;
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-bottom-left-radius: 4px;
}

.msg-citations {
  margin-top: 14px;
  padding-top: 14px;
  border-top: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.citation {
  font-size: 12px;
  color: var(--text-secondary);
  background: var(--bg-raised);
  padding: 10px 14px;
  border-radius: var(--radius-sm);
  border-left: 3px solid var(--accent);
}

.citation-file {
  font-weight: 600;
  color: var(--accent);
  margin-bottom: 3px;
  font-family: var(--font-mono);
  font-size: 11px;
}

.citation-text {
  font-style: italic;
  color: var(--text-tertiary);
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  line-height: 1.5;
}

.chat-input-area {
  padding: 20px 32px;
  border-top: 1px solid var(--border);
  background: var(--bg-raised);
  display: flex;
  gap: 12px;
  align-items: flex-end;
}

.chat-input {
  flex: 1;
  padding: 14px 18px;
  font-size: 14px;
  font-family: var(--font);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  background: var(--bg-surface);
  color: var(--text-primary);
  outline: none;
  resize: none;
  max-height: 160px;
  min-height: 48px;
  line-height: 1.5;
  transition: border-color var(--transition), box-shadow var(--transition);
}
.chat-input:focus {
  border-color: var(--border-accent);
  box-shadow: 0 0 0 3px var(--accent-dim);
}

.chat-send {
  padding: 12px 24px;
  height: 48px;
}

.chat-empty {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: var(--text-tertiary);
  font-size: 14px;
  gap: 6px;
}

.chat-empty::before {
  content: '';
  width: 40px;
  height: 40px;
  border: 2px dashed var(--text-tertiary);
  border-radius: 50%;
  opacity: 0.2;
  margin-bottom: 4px;
}

.typing-indicator {
  display: none;
  align-self: flex-start;
  padding: 14px 20px;
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  border-bottom-left-radius: 4px;
}

.typing-dots {
  display: flex;
  gap: 5px;
}

.typing-dots span {
  width: 7px;
  height: 7px;
  background: var(--text-tertiary);
  border-radius: 50%;
  animation: bounce 1.4s ease-in-out infinite;
}
.typing-dots span:nth-child(2) { animation-delay: 0.2s; }
.typing-dots span:nth-child(3) { animation-delay: 0.4s; }

@keyframes bounce {
  0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
  30% { transform: translateY(-5px); opacity: 1; }
}

/* ═══════════════ PRESENTATIONS ═══════════════ */
.ppt-area {
  flex: 1;
  overflow-y: auto;
  padding: 28px 32px;
}

.ppt-form {
  background: var(--bg-raised);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 28px;
  max-width: 620px;
  margin-bottom: 36px;
}

.ppt-form h3 {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 24px;
  letter-spacing: -0.2px;
}

.form-row {
  display: flex;
  gap: 14px;
  margin-bottom: 20px;
}
.form-row .form-group { flex: 1; margin-bottom: 0; }

.ppt-form .btn { margin-top: 8px; }

.artifacts-section h3 {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 18px;
  letter-spacing: -0.2px;
}

.artifact-list { display: flex; flex-direction: column; gap: 8px; }

.artifact-item {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 16px 20px;
  background: var(--bg-raised);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  transition: all var(--transition);
}
.artifact-item:hover { border-color: rgba(255,255,255,0.08); }

.artifact-icon {
  width: 44px;
  height: 44px;
  border-radius: var(--radius-sm);
  background: var(--accent-dim);
  color: var(--accent);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 10px;
  flex-shrink: 0;
  font-family: var(--font-mono);
  letter-spacing: 0.5px;
}

.artifact-info { flex: 1; min-width: 0; }
.artifact-topic {
  font-size: 14px;
  font-weight: 500;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.artifact-meta {
  font-size: 11px;
  color: var(--text-tertiary);
  display: flex;
  gap: 10px;
  margin-top: 3px;
  font-family: var(--font-mono);
}

.artifact-download {
  padding: 8px 18px;
  font-size: 12px;
}

/* ═══════════════ MODAL ═══════════════ */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 100;
}
.modal-overlay.active { display: flex; }

.modal {
  background: var(--bg-raised);
  border: 1px solid var(--border);
  border-radius: var(--radius-xl);
  padding: 32px;
  width: 100%;
  max-width: 440px;
  box-shadow: var(--shadow-lg);
  animation: modalIn 0.25s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes modalIn {
  from { opacity: 0; transform: scale(0.95); }
  to { opacity: 1; transform: scale(1); }
}

.modal h3 {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 24px;
  letter-spacing: -0.3px;
}

.modal-actions {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  margin-top: 24px;
}

/* ═══════════════ UTILITY ═══════════════ */
.hidden { display: none !important; }

.empty-state {
  text-align: center;
  padding: 48px 24px;
  color: var(--text-tertiary);
  font-size: 14px;
}
.empty-state-icon {
  font-size: 36px;
  opacity: 0.2;
  margin-bottom: 8px;
}

/* ═══════════════ UPLOAD PROGRESS ═══════════════ */
.upload-progress {
  background: var(--bg-raised);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 12px 18px;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 14px;
  animation: msgIn 0.2s ease;
}
.upload-progress-info { flex: 1; min-width: 0; }
.upload-progress-name {
  font-size: 13px;
  font-weight: 500;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.upload-progress-bar {
  height: 3px;
  background: var(--bg-surface-2);
  border-radius: 2px;
  margin-top: 6px;
  overflow: hidden;
}
.upload-progress-fill {
  height: 100%;
  background: var(--accent);
  border-radius: 2px;
  width: 0%;
  animation: uploadPulse 1.5s ease-in-out infinite;
}
@keyframes uploadPulse {
  0% { width: 15%; }
  50% { width: 80%; }
  100% { width: 15%; }
}

/* ═══════════════ KEYBOARD HINT ═══════════════ */
.kbd-hint {
  font-size: 10px;
  color: var(--text-tertiary);
  font-family: var(--font-mono);
  padding: 2px 5px;
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: 3px;
  margin-left: 6px;
  vertical-align: middle;
}

/* ═══════════════ MARKDOWN IN MESSAGES ═══════════════ */
.msg.assistant code {
  background: var(--bg-surface-2);
  padding: 2px 6px;
  border-radius: 4px;
  font-family: var(--font-mono);
  font-size: 12px;
}
.msg.assistant pre {
  background: var(--bg-surface-2);
  padding: 14px 16px;
  border-radius: var(--radius-sm);
  overflow-x: auto;
  margin: 10px 0;
  border: 1px solid var(--border);
}
.msg.assistant pre code {
  background: none;
  padding: 0;
  font-size: 12px;
  line-height: 1.6;
}
.msg.assistant strong { color: var(--accent); font-weight: 600; }
.msg.assistant ul, .msg.assistant ol {
  padding-left: 20px;
  margin: 6px 0;
}
.msg.assistant li { margin: 3px 0; }
.msg.assistant p { margin: 4px 0; }
.msg.assistant h1, .msg.assistant h2, .msg.assistant h3, .msg.assistant h4 {
  margin: 12px 0 6px;
  font-weight: 600;
}

/* ═══════════════ CONFIRM DIALOG ═══════════════ */
.confirm-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(4px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 150;
  animation: modalIn 0.15s ease;
}
.confirm-dialog {
  background: var(--bg-raised);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 28px;
  max-width: 380px;
  width: 90%;
  box-shadow: var(--shadow-lg);
}
.confirm-dialog p {
  font-size: 14px;
  color: var(--text-secondary);
  margin-bottom: 20px;
  line-height: 1.6;
}
.confirm-dialog .modal-actions { margin-top: 0; }

/* ═══════════════ PROJECT CONTEXT MENU ═══════════════ */
.project-item .project-actions {
  margin-left: auto;
  opacity: 0;
  transition: opacity var(--transition);
  display: flex;
  gap: 2px;
}
.project-item:hover .project-actions { opacity: 1; }
.project-action-btn {
  background: none;
  border: none;
  color: var(--text-tertiary);
  cursor: pointer;
  padding: 3px 5px;
  border-radius: 4px;
  font-size: 14px;
  line-height: 1;
  transition: all var(--transition);
}
.project-action-btn:hover { color: var(--error); background: var(--error-dim); }

/* Scrollbar */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.08); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.15); }

/* Spinner */
.spinner {
  width: 16px;
  height: 16px;
  border: 2px solid rgba(12,15,20,0.2);
  border-top-color: var(--bg);
  border-radius: 50%;
  animation: spin 0.6s linear infinite;
  display: inline-block;
}
.spinner.dark {
  border-color: var(--border);
  border-top-color: var(--accent);
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Toast */
.toast-container {
  position: fixed;
  bottom: 24px;
  right: 24px;
  z-index: 200;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.toast {
  padding: 12px 20px;
  background: var(--bg-surface-2);
  color: var(--text-primary);
  border-radius: var(--radius-sm);
  font-size: 13px;
  font-weight: 500;
  box-shadow: var(--shadow-lg);
  animation: toastIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  border: 1px solid var(--border);
  backdrop-filter: blur(12px);
}
.toast.error { border-color: rgba(224,108,117,0.3); color: var(--error); }
.toast.success { border-color: rgba(92,184,122,0.3); color: var(--success); }

@keyframes toastIn {
  from { transform: translateY(12px) scale(0.96); opacity: 0; }
  to { transform: translateY(0) scale(1); opacity: 1; }
}

/* ═══════════════ RESPONSIVE ═══════════════ */
@media (max-width: 768px) {
  .app { flex-direction: column; }
  .sidebar {
    width: 100%;
    min-width: 100%;
    height: auto;
    max-height: 50vh;
    border-right: none;
    border-bottom: 1px solid var(--border);
  }
  .sidebar::after { display: none; }
  .main-header { padding: 16px 20px; }
  .tabs { padding: 0 20px; }
  .files-area, .ppt-area { padding: 20px; }
  .chat-input-area { padding: 14px 20px; }
  .chat-messages { padding: 20px; }
  .chat-controls { padding: 10px 20px; }
  .auth-card { padding: 36px 28px; }
  .msg { max-width: 90%; }
}
</style>
</head>
<body>

<!-- Auth Screen -->
<div id="authScreen" class="auth-screen">
  <div class="auth-card">
    <div class="auth-logo">Planar</div>
    <div class="auth-subtitle" id="authSubtitle">Sign in to your account</div>
    <div class="auth-error" id="authError"></div>
    <form id="authForm">
      <div class="form-group">
        <label for="authUsername">Username</label>
        <input type="text" id="authUsername" placeholder="Enter username" autocomplete="username" required>
      </div>
      <div class="form-group">
        <label for="authPassword">Password</label>
        <input type="password" id="authPassword" placeholder="Enter password" autocomplete="current-password" required>
      </div>
      <button type="submit" class="btn btn-primary btn-full" id="authSubmit">Sign in</button>
    </form>
    <div class="auth-toggle" id="authToggle">
      Don't have an account? <a id="authSwitch">Create one</a>
    </div>
  </div>
</div>

<!-- App -->
<div id="app" class="app">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <span class="sidebar-brand">Planar</span>
    </div>
    <div class="sidebar-user">
      <span id="sidebarUsername">user</span>
      <button id="logoutBtn">Sign out</button>
    </div>
    <div class="sidebar-section-title">Projects</div>
    <div class="project-list" id="projectList"></div>
    <button class="new-project-btn" id="newProjectBtn">+ New project</button>
  </aside>

  <!-- Main -->
  <div class="main" id="mainArea">
    <div class="main-empty" id="noProject">
      <span style="font-size:22px;font-weight:600;color:var(--text-secondary);margin-bottom:4px;">Welcome to Planar</span>
      <span>Select a project from the sidebar or create a new one to get started</span>
    </div>

    <div id="projectView" class="hidden" style="display:none;flex:1;flex-direction:column;overflow:hidden;">
      <div class="main-header">
        <div>
          <h2 id="projectTitle">Project</h2>
          <div class="project-desc" id="projectDesc"></div>
        </div>
      </div>

      <div class="tabs">
        <button class="tab active" data-tab="files">Files</button>
        <button class="tab" data-tab="chat">Chat</button>
        <button class="tab" data-tab="ppt">Presentations</button>
      </div>

      <!-- Files Tab -->
      <div class="tab-content active" id="tab-files">
        <div class="files-area">
          <div class="drop-zone" id="dropZone">
            <div class="drop-zone-icon">&#8693;</div>
            <div class="drop-zone-text">Drop files here or <strong>click to browse</strong></div>
            <div class="drop-zone-hint">PDF, PPTX, XLSX, DOCX, CSV, TXT</div>
            <input type="file" id="fileInput" multiple accept=".pdf,.pptx,.xlsx,.docx,.csv,.txt" style="display:none;">
          </div>
          <div class="file-list" id="fileList"></div>
        </div>
      </div>

      <!-- Chat Tab -->
      <div class="tab-content" id="tab-chat">
        <div class="chat-area">
          <div class="chat-controls">
            <select class="chat-select" id="chatSelect">
              <option value="">Select a conversation...</option>
            </select>
            <button class="btn btn-secondary" id="newChatBtn" style="font-size:12px;padding:9px 16px;">New chat</button>
          </div>
          <div class="chat-messages" id="chatMessages">
            <div class="chat-empty" id="chatEmpty">
              <span style="font-size:16px;font-weight:500;color:var(--text-secondary);">Ask anything</span>
              <span>Type a question below to chat with your project files</span>
            </div>
          </div>
          <div class="typing-indicator" id="typingIndicator">
            <div class="typing-dots"><span></span><span></span><span></span></div>
          </div>
          <div class="chat-input-area">
            <textarea class="chat-input" id="chatInput" placeholder="Ask about your files... Enter to send, Shift+Enter for new line" rows="1"></textarea>
            <button class="btn btn-primary chat-send" id="chatSend">Send</button>
          </div>
        </div>
      </div>

      <!-- PPT Tab -->
      <div class="tab-content" id="tab-ppt">
        <div class="ppt-area">
          <div class="ppt-form">
            <h3>Generate Presentation</h3>
            <form id="pptForm">
              <div class="form-group">
                <label for="pptTopic">Topic</label>
                <input type="text" id="pptTopic" placeholder="What should the presentation be about?" required>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label for="pptAudience">Audience</label>
                  <input type="text" id="pptAudience" value="general" placeholder="e.g., executives, engineers">
                </div>
                <div class="form-group">
                  <label for="pptSlides">Slides</label>
                  <input type="number" id="pptSlides" value="8" min="3" max="30">
                </div>
              </div>
              <div class="form-group">
                <label for="pptStyle">Style</label>
                <select id="pptStyle">
                  <option value="professional">Professional</option>
                  <option value="minimal">Minimal</option>
                  <option value="creative">Creative</option>
                  <option value="academic">Academic</option>
                </select>
              </div>
              <button type="submit" class="btn btn-primary" id="pptSubmit">Generate PPTX</button>
            </form>
          </div>
          <div class="artifacts-section">
            <h3>Generated Presentations</h3>
            <div class="artifact-list" id="artifactList"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- New Project Modal -->
<div class="modal-overlay" id="projectModal">
  <div class="modal">
    <h3>Create Project</h3>
    <form id="projectForm">
      <div class="form-group">
        <label for="projectName">Name</label>
        <input type="text" id="projectName" placeholder="My project" required>
      </div>
      <div class="form-group">
        <label for="projectDescription">Description (optional)</label>
        <textarea id="projectDescription" placeholder="What is this project about?" rows="3"></textarea>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" id="projectModalCancel">Cancel</button>
        <button type="submit" class="btn btn-primary">Create</button>
      </div>
    </form>
  </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<script>
(function() {
  'use strict';

  // -- Config --
  const API = window.location.origin;
  const TOKEN_KEY = 'planar_token';
  const USER_KEY = 'planar_user';

  // -- State --
  let token = localStorage.getItem(TOKEN_KEY) || null;
  let currentUser = localStorage.getItem(USER_KEY) || null;
  let projects = [];
  let currentProject = null;
  let currentChat = null;
  let chats = [];
  let pollInterval = null;

  // -- DOM refs --
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => document.querySelectorAll(sel);

  const authScreen = $('#authScreen');
  const app = $('#app');
  const authForm = $('#authForm');
  const authError = $('#authError');
  const authSubmit = $('#authSubmit');
  const authSubtitle = $('#authSubtitle');
  const authToggle = $('#authToggle');
  const authSwitch = $('#authSwitch');
  const authUsername = $('#authUsername');
  const authPassword = $('#authPassword');

  const sidebarUsername = $('#sidebarUsername');
  const logoutBtn = $('#logoutBtn');
  const projectList = $('#projectList');
  const newProjectBtn = $('#newProjectBtn');
  const noProject = $('#noProject');
  const projectView = $('#projectView');
  const projectTitle = $('#projectTitle');
  const projectDesc = $('#projectDesc');

  const dropZone = $('#dropZone');
  const fileInput = $('#fileInput');
  const fileList = $('#fileList');

  const chatSelect = $('#chatSelect');
  const newChatBtn = $('#newChatBtn');
  const chatMessages = $('#chatMessages');
  const chatEmpty = $('#chatEmpty');
  const chatInput = $('#chatInput');
  const chatSend = $('#chatSend');
  const typingIndicator = $('#typingIndicator');

  const pptForm = $('#pptForm');
  const pptSubmit = $('#pptSubmit');
  const artifactList = $('#artifactList');

  const projectModal = $('#projectModal');
  const projectForm = $('#projectForm');
  const projectModalCancel = $('#projectModalCancel');

  let isRegister = false;

  // -- Helpers --
  function toast(msg, type = '') {
    const el = document.createElement('div');
    el.className = 'toast' + (type ? ' ' + type : '');
    el.textContent = msg;
    $('#toastContainer').appendChild(el);
    setTimeout(() => { el.style.opacity = '0'; el.style.transform = 'translateY(8px)'; el.style.transition = '0.2s ease'; }, 3000);
    setTimeout(() => el.remove(), 3300);
  }

  function confirmAction(message) {
    return new Promise((resolve) => {
      const overlay = document.createElement('div');
      overlay.className = 'confirm-overlay';
      overlay.innerHTML = `
        <div class="confirm-dialog">
          <p>${escapeHtml(message)}</p>
          <div class="modal-actions">
            <button class="btn btn-secondary" data-action="cancel">Cancel</button>
            <button class="btn btn-primary" data-action="confirm" style="background:var(--error);">Delete</button>
          </div>
        </div>
      `;
      document.body.appendChild(overlay);
      overlay.querySelector('[data-action="cancel"]').addEventListener('click', () => { overlay.remove(); resolve(false); });
      overlay.querySelector('[data-action="confirm"]').addEventListener('click', () => { overlay.remove(); resolve(true); });
      overlay.addEventListener('click', (e) => { if (e.target === overlay) { overlay.remove(); resolve(false); } });
    });
  }

  // Simple markdown rendering for assistant messages
  function renderMarkdown(text) {
    if (!text) return '';
    let html = escapeHtml(text);
    // Code blocks
    html = html.replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
    // Inline code
    html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
    // Bold
    html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
    // Italic
    html = html.replace(/(?<!\*)\*([^*]+)\*(?!\*)/g, '<em>$1</em>');
    // Headers
    html = html.replace(/^#### (.+)$/gm, '<h4>$1</h4>');
    html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
    html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
    html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');
    // Lists
    html = html.replace(/^[•\-\*] (.+)$/gm, '<li>$1</li>');
    html = html.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');
    // Numbered lists
    html = html.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');
    // Paragraphs (double newline)
    html = html.replace(/\n\n/g, '</p><p>');
    html = '<p>' + html + '</p>';
    // Clean up empty paragraphs
    html = html.replace(/<p>\s*<\/p>/g, '');
    return html;
  }

  async function api(path, opts = {}) {
    const headers = { ...(opts.headers || {}) };
    if (token) headers['Authorization'] = 'Bearer ' + token;
    if (opts.body && !(opts.body instanceof FormData)) {
      headers['Content-Type'] = 'application/json';
      opts.body = JSON.stringify(opts.body);
    }
    const res = await fetch(API + path, { ...opts, headers });
    if (res.status === 401) {
      logout();
      throw new Error('Session expired');
    }
    if (!res.ok) {
      const data = await res.json().catch(() => ({}));
      throw new Error(data.detail || `Request failed (${res.status})`);
    }
    if (res.status === 204) return null;
    return res.json();
  }

  function formatBytes(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / 1048576).toFixed(1) + ' MB';
  }

  function formatDate(d) {
    return new Date(d).toLocaleDateString(undefined, { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
  }

  function extClass(ext) {
    const e = ext.replace('.', '').toLowerCase();
    return ['pdf','pptx','xlsx','docx','csv','txt'].includes(e) ? e : 'txt';
  }

  // -- Auth --
  function showAuth() {
    authScreen.style.display = 'flex';
    app.classList.remove('active');
  }

  function showApp() {
    authScreen.style.display = 'none';
    app.classList.add('active');
    sidebarUsername.textContent = currentUser || 'user';
    loadProjects();
  }

  authSwitch.addEventListener('click', () => {
    isRegister = !isRegister;
    authSubtitle.textContent = isRegister ? 'Create a new account' : 'Sign in to your account';
    authSubmit.textContent = isRegister ? 'Create account' : 'Sign in';
    authSwitch.textContent = isRegister ? 'Sign in instead' : 'Create one';
    authToggle.firstChild.textContent = isRegister ? 'Already have an account? ' : "Don't have an account? ";
    authError.style.display = 'none';
  });

  authForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    authError.style.display = 'none';
    const username = authUsername.value.trim();
    const password = authPassword.value;
    if (!username || !password) return;

    authSubmit.disabled = true;
    authSubmit.innerHTML = '<span class="spinner"></span>';
    try {
      const endpoint = isRegister ? '/auth/register' : '/auth/login';
      const data = await api(endpoint, { method: 'POST', body: { username, password } });
      token = data.access_token;
      currentUser = username;
      localStorage.setItem(TOKEN_KEY, token);
      localStorage.setItem(USER_KEY, currentUser);
      showApp();
    } catch (err) {
      authError.textContent = err.message;
      authError.style.display = 'block';
    } finally {
      authSubmit.disabled = false;
      authSubmit.textContent = isRegister ? 'Create account' : 'Sign in';
    }
  });

  function logout() {
    token = null;
    currentUser = null;
    currentProject = null;
    currentChat = null;
    localStorage.removeItem(TOKEN_KEY);
    localStorage.removeItem(USER_KEY);
    if (pollInterval) clearInterval(pollInterval);
    showAuth();
  }

  logoutBtn.addEventListener('click', logout);

  // -- Projects --
  async function loadProjects() {
    try {
      projects = await api('/projects');
      renderProjects();
    } catch (err) {
      toast(err.message, 'error');
    }
  }

  function renderProjects() {
    projectList.innerHTML = '';
    if (projects.length === 0) {
      projectList.innerHTML = '<div class="empty-state" style="padding:24px 12px;font-size:13px;">No projects yet</div>';
      return;
    }
    projects.forEach(p => {
      const el = document.createElement('div');
      el.className = 'project-item' + (currentProject && currentProject.id === p.id ? ' active' : '');
      el.innerHTML = '<span class="dot"></span><span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + escapeHtml(p.name) + '</span><span class="project-actions"><button class="project-action-btn" title="Delete project">&times;</button></span>';
      el.addEventListener('click', (e) => {
        if (e.target.closest('.project-action-btn')) return;
        selectProject(p);
      });
      el.querySelector('.project-action-btn').addEventListener('click', async (e) => {
        e.stopPropagation();
        const confirmed = await confirmAction('Delete project "' + p.name + '"? All files, chats, and presentations will be permanently removed.');
        if (!confirmed) return;
        try {
          await api('/projects/' + p.id, { method: 'DELETE' });
          projects = projects.filter(x => x.id !== p.id);
          if (currentProject && currentProject.id === p.id) {
            currentProject = null;
            noProject.style.display = 'flex';
            projectView.style.display = 'none';
            if (pollInterval) clearInterval(pollInterval);
          }
          renderProjects();
          toast('Project deleted', 'success');
        } catch (err) {
          toast(err.message, 'error');
        }
      });
      projectList.appendChild(el);
    });
  }

  function selectProject(p) {
    currentProject = p;
    currentChat = null;
    renderProjects();
    noProject.style.display = 'none';
    projectView.style.display = 'flex';
    projectView.classList.remove('hidden');
    projectTitle.textContent = p.name;
    projectDesc.textContent = p.description || '';

    // Reset to files tab
    activateTab('files');

    loadFiles();
    loadChats();
    loadArtifacts();

    // Poll for status updates
    if (pollInterval) clearInterval(pollInterval);
    pollInterval = setInterval(() => {
      loadFiles();
      loadArtifacts();
    }, 8000);
  }

  newProjectBtn.addEventListener('click', () => {
    projectModal.classList.add('active');
    $('#projectName').value = '';
    $('#projectDescription').value = '';
    $('#projectName').focus();
  });

  projectModalCancel.addEventListener('click', () => projectModal.classList.remove('active'));
  projectModal.addEventListener('click', (e) => {
    if (e.target === projectModal) projectModal.classList.remove('active');
  });

  projectForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = $('#projectName').value.trim();
    const description = $('#projectDescription').value.trim();
    if (!name) return;
    try {
      const p = await api('/projects', { method: 'POST', body: { name, description } });
      projectModal.classList.remove('active');
      projects.unshift(p);
      selectProject(p);
    } catch (err) {
      toast(err.message, 'error');
    }
  });

  // -- Tabs --
  function activateTab(name) {
    $$('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === name));
    $$('.tab-content').forEach(tc => tc.classList.toggle('active', tc.id === 'tab-' + name));
  }

  $$('.tab').forEach(t => t.addEventListener('click', () => activateTab(t.dataset.tab)));

  // -- Files --
  async function loadFiles() {
    if (!currentProject) return;
    try {
      const files = await api('/projects/' + currentProject.id + '/files');
      renderFiles(files);
    } catch (err) { /* silent */ }
  }

  function renderFiles(files) {
    if (files.length === 0) {
      fileList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">&#128196;</div>No files uploaded yet</div>';
      return;
    }
    fileList.innerHTML = '';
    files.forEach(f => {
      const el = document.createElement('div');
      el.className = 'file-item';
      el.innerHTML = `
        <div class="file-icon ${extClass(f.extension)}">${f.extension.replace('.','').toUpperCase()}</div>
        <div class="file-info">
          <div class="file-name">${escapeHtml(f.original_name)}</div>
          <div class="file-meta">
            <span>${formatBytes(f.size_bytes)}</span>
            <span>${formatDate(f.created_at)}</span>
          </div>
        </div>
        <span class="file-status ${f.status}">${f.status}</span>
        <button class="file-delete" data-id="${f.id}" title="Delete">&times;</button>
      `;
      el.querySelector('.file-delete').addEventListener('click', () => deleteFile(f.id, f.original_name));
      fileList.appendChild(el);
    });
  }

  async function deleteFile(id, name) {
    const confirmed = await confirmAction('Delete "' + (name || 'this file') + '"? The file and its embeddings will be permanently removed.');
    if (!confirmed) return;
    try {
      await api('/projects/' + currentProject.id + '/files/' + id, { method: 'DELETE' });
      loadFiles();
      toast('File deleted', 'success');
    } catch (err) {
      toast(err.message, 'error');
    }
  }

  // Drag & drop
  dropZone.addEventListener('click', () => fileInput.click());
  dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
  dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
  dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('drag-over');
    uploadFiles(e.dataTransfer.files);
  });
  fileInput.addEventListener('change', () => {
    uploadFiles(fileInput.files);
    fileInput.value = '';
  });

  async function uploadFiles(files) {
    for (const file of files) {
      // Show upload progress indicator
      const progressEl = document.createElement('div');
      progressEl.className = 'upload-progress';
      progressEl.innerHTML = `
        <div class="file-icon ${extClass(file.name.split('.').pop())}">${file.name.split('.').pop().toUpperCase()}</div>
        <div class="upload-progress-info">
          <div class="upload-progress-name">${escapeHtml(file.name)}</div>
          <div class="upload-progress-bar"><div class="upload-progress-fill"></div></div>
        </div>
      `;
      fileList.prepend(progressEl);

      try {
        const fd = new FormData();
        fd.append('file', file);
        await api('/projects/' + currentProject.id + '/files', { method: 'POST', body: fd });
        toast('Uploaded ' + file.name, 'success');
      } catch (err) {
        toast('Upload failed: ' + err.message, 'error');
      }
      progressEl.remove();
    }
    loadFiles();
  }

  // -- Chat --
  async function loadChats() {
    if (!currentProject) return;
    try {
      chats = await api('/projects/' + currentProject.id + '/chats');
      renderChatSelect();
    } catch (err) { /* silent */ }
  }

  function renderChatSelect() {
    chatSelect.innerHTML = '<option value="">Select a conversation...</option>';
    chats.forEach((c, i) => {
      const opt = document.createElement('option');
      opt.value = c.id;
      opt.textContent = 'Chat ' + (chats.length - i) + ' - ' + formatDate(c.created_at);
      if (currentChat && currentChat.id === c.id) opt.selected = true;
      chatSelect.appendChild(opt);
    });
  }

  chatSelect.addEventListener('change', () => {
    const id = chatSelect.value;
    if (!id) {
      currentChat = null;
      chatMessages.innerHTML = '';
      chatEmpty.style.display = 'flex';
      return;
    }
    currentChat = chats.find(c => c.id === id) || null;
    loadMessages();
  });

  newChatBtn.addEventListener('click', async () => {
    if (!currentProject) return;
    try {
      const chat = await api('/projects/' + currentProject.id + '/chats', { method: 'POST' });
      chats.unshift(chat);
      currentChat = chat;
      renderChatSelect();
      chatMessages.innerHTML = '';
      chatEmpty.style.display = 'flex';
    } catch (err) {
      toast(err.message, 'error');
    }
  });

  async function loadMessages() {
    if (!currentProject || !currentChat) return;
    try {
      const msgs = await api('/projects/' + currentProject.id + '/chats/' + currentChat.id + '/messages');
      renderMessages(msgs);
    } catch (err) {
      toast(err.message, 'error');
    }
  }

  function renderMessages(msgs) {
    chatMessages.innerHTML = '';
    if (msgs.length === 0) {
      chatEmpty.style.display = 'flex';
      chatMessages.appendChild(chatEmpty);
      return;
    }
    chatEmpty.style.display = 'none';
    msgs.forEach(m => appendMessage(m));
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  function appendMessage(m) {
    chatEmpty.style.display = 'none';
    const el = document.createElement('div');
    el.className = 'msg ' + m.role;
    let html = m.role === 'assistant' ? renderMarkdown(m.content) : escapeHtml(m.content);
    if (m.role === 'assistant' && m.citations && m.citations.length > 0) {
      html += '<div class="msg-citations">';
      m.citations.forEach(c => {
        html += `<div class="citation">
          <div class="citation-file">${escapeHtml(c.file_name)}</div>
          <div class="citation-text">${escapeHtml(c.chunk_text)}</div>
        </div>`;
      });
      html += '</div>';
    }
    el.innerHTML = html;
    chatMessages.appendChild(el);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  async function sendMessage() {
    const content = chatInput.value.trim();
    if (!content || !currentProject) return;

    // Auto-create chat if none selected
    if (!currentChat) {
      try {
        const chat = await api('/projects/' + currentProject.id + '/chats', { method: 'POST' });
        chats.unshift(chat);
        currentChat = chat;
        renderChatSelect();
      } catch (err) {
        toast(err.message, 'error');
        return;
      }
    }

    chatInput.value = '';
    chatInput.style.height = 'auto';
    appendMessage({ role: 'user', content, citations: null });

    typingIndicator.style.display = 'block';
    chatMessages.scrollTop = chatMessages.scrollHeight;
    chatSend.disabled = true;

    try {
      const resp = await api('/projects/' + currentProject.id + '/chats/' + currentChat.id + '/messages', {
        method: 'POST',
        body: { content },
      });
      typingIndicator.style.display = 'none';
      appendMessage(resp);
    } catch (err) {
      typingIndicator.style.display = 'none';
      toast(err.message, 'error');
    } finally {
      chatSend.disabled = false;
    }
  }

  chatSend.addEventListener('click', sendMessage);
  chatInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  // Auto-resize chat input
  chatInput.addEventListener('input', () => {
    chatInput.style.height = 'auto';
    chatInput.style.height = Math.min(chatInput.scrollHeight, 160) + 'px';
  });

  // -- PPT --
  pptForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!currentProject) return;

    const topic = $('#pptTopic').value.trim();
    const audience = $('#pptAudience').value.trim() || 'general';
    const num_slides = parseInt($('#pptSlides').value) || 8;
    const style = $('#pptStyle').value;

    if (!topic) return;

    pptSubmit.disabled = true;
    pptSubmit.innerHTML = '<span class="spinner"></span> Generating...';

    try {
      await api('/projects/' + currentProject.id + '/ppt', {
        method: 'POST',
        body: { topic, audience, num_slides, style },
      });
      toast('Presentation queued', 'success');
      $('#pptTopic').value = '';
      loadArtifacts();
    } catch (err) {
      toast(err.message, 'error');
    } finally {
      pptSubmit.disabled = false;
      pptSubmit.textContent = 'Generate PPTX';
    }
  });

  async function loadArtifacts() {
    if (!currentProject) return;
    try {
      const artifacts = await api('/projects/' + currentProject.id + '/artifacts');
      renderArtifacts(artifacts);
    } catch (err) { /* silent */ }
  }

  function renderArtifacts(artifacts) {
    if (artifacts.length === 0) {
      artifactList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">&#128202;</div>No presentations generated yet</div>';
      return;
    }
    artifactList.innerHTML = '';
    artifacts.forEach(a => {
      const meta = a.metadata_json || {};
      const el = document.createElement('div');
      el.className = 'artifact-item';
      el.innerHTML = `
        <div class="artifact-icon">PPTX</div>
        <div class="artifact-info">
          <div class="artifact-topic">${escapeHtml(meta.topic || 'Presentation')}</div>
          <div class="artifact-meta">
            <span>${meta.num_slides || '?'} slides</span>
            <span>${escapeHtml(meta.style || '')}</span>
            <span class="file-status ${a.status}">${a.status}</span>
            <span>${formatDate(a.created_at)}</span>
          </div>
        </div>
        ${a.status === 'ready' ? '<a href="' + API + '/artifacts/' + a.id + '/download" class="btn btn-primary artifact-download" target="_blank">Download</a>' : ''}
      `;
      artifactList.appendChild(el);
    });
  }

  // -- Escape HTML --
  function escapeHtml(str) {
    if (!str) return '';
    const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
    return str.replace(/[&<>"']/g, c => map[c]);
  }

  // -- Keyboard shortcuts --
  document.addEventListener('keydown', (e) => {
    // Escape to close modals
    if (e.key === 'Escape') {
      if (projectModal.classList.contains('active')) projectModal.classList.remove('active');
      const confirm = document.querySelector('.confirm-overlay');
      if (confirm) confirm.remove();
    }
    // Ctrl/Cmd+K to focus chat input when in chat tab
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
      const chatTab = document.querySelector('.tab[data-tab="chat"]');
      if (chatTab && currentProject) {
        e.preventDefault();
        activateTab('chat');
        chatInput.focus();
      }
    }
  });

  // -- Init --
  if (token) {
    showApp();
  } else {
    showAuth();
  }
})();
</script>
</body>
</html>
