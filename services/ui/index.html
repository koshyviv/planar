<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Planar</title>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #FAF9F7;
  --bg-card: #FFFFFF;
  --bg-sidebar: #F5F4F1;
  --bg-hover: #EEEDEA;
  --bg-active: #E8E7E4;
  --accent: #D97757;
  --accent-hover: #C4663F;
  --accent-light: rgba(217, 119, 87, 0.08);
  --text-primary: #1A1A1A;
  --text-secondary: #6B6560;
  --text-tertiary: #9B9590;
  --border: #E5E3E0;
  --border-light: #EEEDE9;
  --success: #4A9E6B;
  --warning: #D4943A;
  --error: #C74E4E;
  --radius: 10px;
  --radius-sm: 6px;
  --radius-lg: 14px;
  --shadow-sm: 0 1px 2px rgba(0,0,0,0.04);
  --shadow-md: 0 2px 8px rgba(0,0,0,0.06);
  --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
  --transition: 150ms ease;
}

html, body { height: 100%; }

body {
  font-family: var(--font);
  background: var(--bg);
  color: var(--text-primary);
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
}

/* Auth Screen */
.auth-screen {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100vh;
  padding: 20px;
}

.auth-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 40px;
  width: 100%;
  max-width: 400px;
  box-shadow: var(--shadow-md);
}

.auth-logo {
  font-size: 24px;
  font-weight: 600;
  letter-spacing: -0.5px;
  margin-bottom: 4px;
}

.auth-subtitle {
  color: var(--text-secondary);
  font-size: 14px;
  margin-bottom: 32px;
}

.form-group { margin-bottom: 16px; }

.form-group label {
  display: block;
  font-size: 13px;
  font-weight: 500;
  color: var(--text-secondary);
  margin-bottom: 6px;
}

input[type="text"],
input[type="password"],
input[type="number"],
textarea,
select {
  width: 100%;
  padding: 10px 12px;
  font-size: 14px;
  font-family: var(--font);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  background: var(--bg);
  color: var(--text-primary);
  outline: none;
  transition: border-color var(--transition);
}

input:focus, textarea:focus, select:focus {
  border-color: var(--accent);
}

textarea { resize: vertical; min-height: 80px; }

.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 10px 18px;
  font-size: 14px;
  font-weight: 500;
  font-family: var(--font);
  border: none;
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: all var(--transition);
  text-decoration: none;
}

.btn-primary {
  background: var(--accent);
  color: #fff;
}
.btn-primary:hover { background: var(--accent-hover); }
.btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

.btn-secondary {
  background: transparent;
  color: var(--text-secondary);
  border: 1px solid var(--border);
}
.btn-secondary:hover { background: var(--bg-hover); }

.btn-ghost {
  background: transparent;
  color: var(--text-secondary);
  padding: 6px 10px;
}
.btn-ghost:hover { background: var(--bg-hover); color: var(--text-primary); }

.btn-full { width: 100%; }

.auth-toggle {
  text-align: center;
  margin-top: 20px;
  font-size: 13px;
  color: var(--text-secondary);
}
.auth-toggle a {
  color: var(--accent);
  cursor: pointer;
  text-decoration: none;
  font-weight: 500;
}
.auth-toggle a:hover { text-decoration: underline; }

.auth-error {
  background: rgba(199, 78, 78, 0.08);
  color: var(--error);
  font-size: 13px;
  padding: 8px 12px;
  border-radius: var(--radius-sm);
  margin-bottom: 16px;
  display: none;
}

/* App Layout */
.app {
  display: none;
  height: 100vh;
}
.app.active { display: flex; }

/* Sidebar */
.sidebar {
  width: 260px;
  min-width: 260px;
  background: var(--bg-sidebar);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  height: 100vh;
}

.sidebar-header {
  padding: 16px 16px 12px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid var(--border-light);
}

.sidebar-brand {
  font-size: 18px;
  font-weight: 600;
  letter-spacing: -0.3px;
}

.sidebar-user {
  font-size: 12px;
  color: var(--text-tertiary);
  padding: 10px 16px;
  border-bottom: 1px solid var(--border-light);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.sidebar-user button {
  font-size: 12px;
  color: var(--text-tertiary);
  background: none;
  border: none;
  cursor: pointer;
  font-family: var(--font);
}
.sidebar-user button:hover { color: var(--error); }

.sidebar-section-title {
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-tertiary);
  padding: 16px 16px 8px;
}

.project-list {
  flex: 1;
  overflow-y: auto;
  padding: 0 8px 8px;
}

.project-item {
  padding: 8px 12px;
  border-radius: var(--radius-sm);
  cursor: pointer;
  font-size: 14px;
  color: var(--text-secondary);
  transition: all var(--transition);
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 1px;
}
.project-item:hover { background: var(--bg-hover); color: var(--text-primary); }
.project-item.active { background: var(--accent-light); color: var(--accent); font-weight: 500; }

.project-item .dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--text-tertiary);
  flex-shrink: 0;
}
.project-item.active .dot { background: var(--accent); }

.new-project-btn {
  margin: 8px;
  padding: 8px;
  border: 1px dashed var(--border);
  border-radius: var(--radius-sm);
  background: transparent;
  color: var(--text-secondary);
  font-size: 13px;
  font-family: var(--font);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  transition: all var(--transition);
}
.new-project-btn:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-light); }

/* Main Content */
.main {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.main-empty {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-tertiary);
  font-size: 15px;
}

.main-header {
  padding: 16px 24px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: var(--bg-card);
}

.main-header h2 {
  font-size: 18px;
  font-weight: 600;
  letter-spacing: -0.3px;
}

.main-header .project-desc {
  font-size: 13px;
  color: var(--text-secondary);
  margin-top: 2px;
}

/* Tabs */
.tabs {
  display: flex;
  gap: 0;
  border-bottom: 1px solid var(--border);
  background: var(--bg-card);
  padding: 0 24px;
}

.tab {
  padding: 12px 20px;
  font-size: 14px;
  font-weight: 500;
  color: var(--text-secondary);
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all var(--transition);
  font-family: var(--font);
  background: none;
  border-top: none;
  border-left: none;
  border-right: none;
}
.tab:hover { color: var(--text-primary); }
.tab.active { color: var(--accent); border-bottom-color: var(--accent); }

.tab-content {
  flex: 1;
  overflow: hidden;
  display: none;
}
.tab-content.active { display: flex; flex-direction: column; }

/* Files Tab */
.files-area {
  flex: 1;
  overflow-y: auto;
  padding: 24px;
}

.drop-zone {
  border: 2px dashed var(--border);
  border-radius: var(--radius);
  padding: 40px 24px;
  text-align: center;
  transition: all var(--transition);
  margin-bottom: 24px;
  cursor: pointer;
}
.drop-zone:hover, .drop-zone.drag-over {
  border-color: var(--accent);
  background: var(--accent-light);
}

.drop-zone-icon {
  font-size: 32px;
  margin-bottom: 8px;
  opacity: 0.4;
}

.drop-zone-text {
  font-size: 14px;
  color: var(--text-secondary);
}
.drop-zone-text strong { color: var(--accent); }

.drop-zone-hint {
  font-size: 12px;
  color: var(--text-tertiary);
  margin-top: 4px;
}

.file-list { display: flex; flex-direction: column; gap: 6px; }

.file-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 14px;
  background: var(--bg-card);
  border: 1px solid var(--border-light);
  border-radius: var(--radius-sm);
}

.file-icon {
  width: 36px;
  height: 36px;
  border-radius: var(--radius-sm);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: 600;
  color: #fff;
  flex-shrink: 0;
  text-transform: uppercase;
}
.file-icon.pdf { background: #C74E4E; }
.file-icon.pptx { background: #D97757; }
.file-icon.xlsx { background: #4A9E6B; }
.file-icon.docx { background: #5B7BB5; }
.file-icon.csv { background: #7B6BB5; }
.file-icon.txt { background: #9B9590; }

.file-info { flex: 1; min-width: 0; }
.file-name {
  font-size: 14px;
  font-weight: 500;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.file-meta {
  font-size: 12px;
  color: var(--text-tertiary);
  display: flex;
  gap: 10px;
}

.file-status {
  font-size: 12px;
  font-weight: 500;
  padding: 3px 8px;
  border-radius: 12px;
  flex-shrink: 0;
}
.file-status.pending { background: rgba(212, 148, 58, 0.1); color: var(--warning); }
.file-status.processing { background: rgba(91, 123, 181, 0.1); color: #5B7BB5; }
.file-status.ready { background: rgba(74, 158, 107, 0.1); color: var(--success); }
.file-status.error { background: rgba(199, 78, 78, 0.1); color: var(--error); }

.file-delete {
  background: none;
  border: none;
  color: var(--text-tertiary);
  cursor: pointer;
  padding: 4px;
  border-radius: 4px;
  font-size: 16px;
  line-height: 1;
  transition: all var(--transition);
}
.file-delete:hover { color: var(--error); background: rgba(199, 78, 78, 0.08); }

/* Chat Tab */
.chat-area {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.chat-controls {
  padding: 12px 24px;
  display: flex;
  align-items: center;
  gap: 10px;
  border-bottom: 1px solid var(--border-light);
  background: var(--bg-card);
}

.chat-select {
  flex: 1;
  padding: 8px 10px;
  font-size: 13px;
  font-family: var(--font);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  background: var(--bg);
  color: var(--text-primary);
  outline: none;
}
.chat-select:focus { border-color: var(--accent); }

.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 24px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.msg {
  max-width: 720px;
  padding: 14px 18px;
  border-radius: var(--radius);
  font-size: 14px;
  line-height: 1.65;
  word-wrap: break-word;
  white-space: pre-wrap;
}

.msg.user {
  align-self: flex-end;
  background: var(--accent);
  color: #fff;
  border-bottom-right-radius: 4px;
}

.msg.assistant {
  align-self: flex-start;
  background: var(--bg-card);
  border: 1px solid var(--border-light);
  border-bottom-left-radius: 4px;
}

.msg-citations {
  margin-top: 10px;
  padding-top: 10px;
  border-top: 1px solid var(--border-light);
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.citation {
  font-size: 12px;
  color: var(--text-secondary);
  background: var(--bg);
  padding: 6px 10px;
  border-radius: var(--radius-sm);
  border-left: 3px solid var(--accent);
}

.citation-file {
  font-weight: 600;
  color: var(--accent);
  margin-bottom: 2px;
}

.citation-text {
  font-style: italic;
  color: var(--text-tertiary);
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
}

.chat-input-area {
  padding: 16px 24px;
  border-top: 1px solid var(--border);
  background: var(--bg-card);
  display: flex;
  gap: 10px;
  align-items: flex-end;
}

.chat-input {
  flex: 1;
  padding: 12px 14px;
  font-size: 14px;
  font-family: var(--font);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  background: var(--bg);
  color: var(--text-primary);
  outline: none;
  resize: none;
  max-height: 150px;
  min-height: 44px;
  line-height: 1.4;
}
.chat-input:focus { border-color: var(--accent); }

.chat-send {
  padding: 10px 18px;
  height: 44px;
}

.chat-empty {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-tertiary);
  font-size: 14px;
}

.typing-indicator {
  display: none;
  align-self: flex-start;
  padding: 12px 18px;
  background: var(--bg-card);
  border: 1px solid var(--border-light);
  border-radius: var(--radius);
  border-bottom-left-radius: 4px;
}

.typing-dots {
  display: flex;
  gap: 4px;
}

.typing-dots span {
  width: 6px;
  height: 6px;
  background: var(--text-tertiary);
  border-radius: 50%;
  animation: bounce 1.2s ease-in-out infinite;
}
.typing-dots span:nth-child(2) { animation-delay: 0.2s; }
.typing-dots span:nth-child(3) { animation-delay: 0.4s; }

@keyframes bounce {
  0%, 60%, 100% { transform: translateY(0); }
  30% { transform: translateY(-4px); }
}

/* PPT Tab */
.ppt-area {
  flex: 1;
  overflow-y: auto;
  padding: 24px;
}

.ppt-form {
  background: var(--bg-card);
  border: 1px solid var(--border-light);
  border-radius: var(--radius);
  padding: 24px;
  max-width: 600px;
  margin-bottom: 32px;
}

.ppt-form h3 {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 20px;
}

.form-row {
  display: flex;
  gap: 12px;
  margin-bottom: 16px;
}
.form-row .form-group { flex: 1; margin-bottom: 0; }

.ppt-form .btn { margin-top: 8px; }

.artifacts-section h3 {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 16px;
}

.artifact-list { display: flex; flex-direction: column; gap: 8px; }

.artifact-item {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 14px 16px;
  background: var(--bg-card);
  border: 1px solid var(--border-light);
  border-radius: var(--radius-sm);
}

.artifact-icon {
  width: 40px;
  height: 40px;
  border-radius: var(--radius-sm);
  background: var(--accent-light);
  color: var(--accent);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 11px;
  flex-shrink: 0;
}

.artifact-info { flex: 1; min-width: 0; }
.artifact-topic {
  font-size: 14px;
  font-weight: 500;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.artifact-meta {
  font-size: 12px;
  color: var(--text-tertiary);
  display: flex;
  gap: 8px;
}

.artifact-download {
  padding: 6px 14px;
  font-size: 13px;
}

/* Modal overlay */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.3);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 100;
}
.modal-overlay.active { display: flex; }

.modal {
  background: var(--bg-card);
  border-radius: var(--radius-lg);
  padding: 28px;
  width: 100%;
  max-width: 420px;
  box-shadow: var(--shadow-md);
}

.modal h3 {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 20px;
}

.modal-actions {
  display: flex;
  justify-content: flex-end;
  gap: 8px;
  margin-top: 20px;
}

/* Utility */
.hidden { display: none !important; }

.empty-state {
  text-align: center;
  padding: 48px 24px;
  color: var(--text-tertiary);
  font-size: 14px;
}
.empty-state-icon {
  font-size: 36px;
  opacity: 0.3;
  margin-bottom: 8px;
}

/* Scrollbar */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-tertiary); }

/* Loading spinner */
.spinner {
  width: 16px;
  height: 16px;
  border: 2px solid rgba(255,255,255,0.3);
  border-top-color: #fff;
  border-radius: 50%;
  animation: spin 0.6s linear infinite;
  display: inline-block;
}
.spinner.dark {
  border-color: var(--border);
  border-top-color: var(--accent);
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Toast */
.toast-container {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 200;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.toast {
  padding: 10px 16px;
  background: var(--text-primary);
  color: #fff;
  border-radius: var(--radius-sm);
  font-size: 13px;
  box-shadow: var(--shadow-md);
  animation: slideIn 0.2s ease;
}
.toast.error { background: var(--error); }
.toast.success { background: var(--success); }

@keyframes slideIn {
  from { transform: translateY(10px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}
</style>
</head>
<body>

<!-- Auth Screen -->
<div id="authScreen" class="auth-screen">
  <div class="auth-card">
    <div class="auth-logo">Planar</div>
    <div class="auth-subtitle" id="authSubtitle">Sign in to your account</div>
    <div class="auth-error" id="authError"></div>
    <form id="authForm">
      <div class="form-group">
        <label for="authUsername">Username</label>
        <input type="text" id="authUsername" placeholder="Enter username" autocomplete="username" required>
      </div>
      <div class="form-group">
        <label for="authPassword">Password</label>
        <input type="password" id="authPassword" placeholder="Enter password" autocomplete="current-password" required>
      </div>
      <button type="submit" class="btn btn-primary btn-full" id="authSubmit">Sign in</button>
    </form>
    <div class="auth-toggle" id="authToggle">
      Don't have an account? <a id="authSwitch">Create one</a>
    </div>
  </div>
</div>

<!-- App -->
<div id="app" class="app">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <span class="sidebar-brand">Planar</span>
    </div>
    <div class="sidebar-user">
      <span id="sidebarUsername">user</span>
      <button id="logoutBtn">Sign out</button>
    </div>
    <div class="sidebar-section-title">Projects</div>
    <div class="project-list" id="projectList"></div>
    <button class="new-project-btn" id="newProjectBtn">+ New project</button>
  </aside>

  <!-- Main -->
  <div class="main" id="mainArea">
    <div class="main-empty" id="noProject">
      Select a project or create a new one
    </div>

    <div id="projectView" class="hidden" style="display:none;flex:1;flex-direction:column;overflow:hidden;">
      <div class="main-header">
        <div>
          <h2 id="projectTitle">Project</h2>
          <div class="project-desc" id="projectDesc"></div>
        </div>
      </div>

      <div class="tabs">
        <button class="tab active" data-tab="files">Files</button>
        <button class="tab" data-tab="chat">Chat</button>
        <button class="tab" data-tab="ppt">Presentations</button>
      </div>

      <!-- Files Tab -->
      <div class="tab-content active" id="tab-files">
        <div class="files-area">
          <div class="drop-zone" id="dropZone">
            <div class="drop-zone-icon">&#8693;</div>
            <div class="drop-zone-text">Drop files here or <strong>click to browse</strong></div>
            <div class="drop-zone-hint">PDF, PPTX, XLSX, DOCX, CSV, TXT</div>
            <input type="file" id="fileInput" multiple accept=".pdf,.pptx,.xlsx,.docx,.csv,.txt" style="display:none;">
          </div>
          <div class="file-list" id="fileList"></div>
        </div>
      </div>

      <!-- Chat Tab -->
      <div class="tab-content" id="tab-chat">
        <div class="chat-area">
          <div class="chat-controls">
            <select class="chat-select" id="chatSelect">
              <option value="">Select a conversation...</option>
            </select>
            <button class="btn btn-secondary" id="newChatBtn" style="font-size:13px;padding:8px 14px;">New chat</button>
          </div>
          <div class="chat-messages" id="chatMessages">
            <div class="chat-empty" id="chatEmpty">Start a conversation about your project files</div>
          </div>
          <div class="typing-indicator" id="typingIndicator">
            <div class="typing-dots"><span></span><span></span><span></span></div>
          </div>
          <div class="chat-input-area">
            <textarea class="chat-input" id="chatInput" placeholder="Ask a question about your files..." rows="1"></textarea>
            <button class="btn btn-primary chat-send" id="chatSend">Send</button>
          </div>
        </div>
      </div>

      <!-- PPT Tab -->
      <div class="tab-content" id="tab-ppt">
        <div class="ppt-area">
          <div class="ppt-form">
            <h3>Generate Presentation</h3>
            <form id="pptForm">
              <div class="form-group">
                <label for="pptTopic">Topic</label>
                <input type="text" id="pptTopic" placeholder="What should the presentation be about?" required>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label for="pptAudience">Audience</label>
                  <input type="text" id="pptAudience" value="general" placeholder="e.g., executives, engineers">
                </div>
                <div class="form-group">
                  <label for="pptSlides">Slides</label>
                  <input type="number" id="pptSlides" value="8" min="3" max="30">
                </div>
              </div>
              <div class="form-group">
                <label for="pptStyle">Style</label>
                <select id="pptStyle">
                  <option value="professional">Professional</option>
                  <option value="minimal">Minimal</option>
                  <option value="creative">Creative</option>
                  <option value="academic">Academic</option>
                </select>
              </div>
              <button type="submit" class="btn btn-primary" id="pptSubmit">Generate PPTX</button>
            </form>
          </div>
          <div class="artifacts-section">
            <h3>Generated Presentations</h3>
            <div class="artifact-list" id="artifactList"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- New Project Modal -->
<div class="modal-overlay" id="projectModal">
  <div class="modal">
    <h3>Create Project</h3>
    <form id="projectForm">
      <div class="form-group">
        <label for="projectName">Name</label>
        <input type="text" id="projectName" placeholder="My project" required>
      </div>
      <div class="form-group">
        <label for="projectDescription">Description (optional)</label>
        <textarea id="projectDescription" placeholder="What is this project about?" rows="3"></textarea>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" id="projectModalCancel">Cancel</button>
        <button type="submit" class="btn btn-primary">Create</button>
      </div>
    </form>
  </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<script>
(function() {
  'use strict';

  // -- Config --
  const API = window.location.origin;
  const TOKEN_KEY = 'planar_token';
  const USER_KEY = 'planar_user';

  // -- State --
  let token = localStorage.getItem(TOKEN_KEY) || null;
  let currentUser = localStorage.getItem(USER_KEY) || null;
  let projects = [];
  let currentProject = null;
  let currentChat = null;
  let chats = [];
  let pollInterval = null;

  // -- DOM refs --
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => document.querySelectorAll(sel);

  const authScreen = $('#authScreen');
  const app = $('#app');
  const authForm = $('#authForm');
  const authError = $('#authError');
  const authSubmit = $('#authSubmit');
  const authSubtitle = $('#authSubtitle');
  const authToggle = $('#authToggle');
  const authSwitch = $('#authSwitch');
  const authUsername = $('#authUsername');
  const authPassword = $('#authPassword');

  const sidebarUsername = $('#sidebarUsername');
  const logoutBtn = $('#logoutBtn');
  const projectList = $('#projectList');
  const newProjectBtn = $('#newProjectBtn');
  const noProject = $('#noProject');
  const projectView = $('#projectView');
  const projectTitle = $('#projectTitle');
  const projectDesc = $('#projectDesc');

  const dropZone = $('#dropZone');
  const fileInput = $('#fileInput');
  const fileList = $('#fileList');

  const chatSelect = $('#chatSelect');
  const newChatBtn = $('#newChatBtn');
  const chatMessages = $('#chatMessages');
  const chatEmpty = $('#chatEmpty');
  const chatInput = $('#chatInput');
  const chatSend = $('#chatSend');
  const typingIndicator = $('#typingIndicator');

  const pptForm = $('#pptForm');
  const pptSubmit = $('#pptSubmit');
  const artifactList = $('#artifactList');

  const projectModal = $('#projectModal');
  const projectForm = $('#projectForm');
  const projectModalCancel = $('#projectModalCancel');

  let isRegister = false;

  // -- Helpers --
  function toast(msg, type = '') {
    const el = document.createElement('div');
    el.className = 'toast' + (type ? ' ' + type : '');
    el.textContent = msg;
    $('#toastContainer').appendChild(el);
    setTimeout(() => el.remove(), 3500);
  }

  async function api(path, opts = {}) {
    const headers = { ...(opts.headers || {}) };
    if (token) headers['Authorization'] = 'Bearer ' + token;
    if (opts.body && !(opts.body instanceof FormData)) {
      headers['Content-Type'] = 'application/json';
      opts.body = JSON.stringify(opts.body);
    }
    const res = await fetch(API + path, { ...opts, headers });
    if (res.status === 401) {
      logout();
      throw new Error('Session expired');
    }
    if (!res.ok) {
      const data = await res.json().catch(() => ({}));
      throw new Error(data.detail || `Request failed (${res.status})`);
    }
    if (res.status === 204) return null;
    return res.json();
  }

  function formatBytes(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / 1048576).toFixed(1) + ' MB';
  }

  function formatDate(d) {
    return new Date(d).toLocaleDateString(undefined, { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
  }

  function extClass(ext) {
    const e = ext.replace('.', '').toLowerCase();
    return ['pdf','pptx','xlsx','docx','csv','txt'].includes(e) ? e : 'txt';
  }

  // -- Auth --
  function showAuth() {
    authScreen.style.display = 'flex';
    app.classList.remove('active');
  }

  function showApp() {
    authScreen.style.display = 'none';
    app.classList.add('active');
    sidebarUsername.textContent = currentUser || 'user';
    loadProjects();
  }

  authSwitch.addEventListener('click', () => {
    isRegister = !isRegister;
    authSubtitle.textContent = isRegister ? 'Create a new account' : 'Sign in to your account';
    authSubmit.textContent = isRegister ? 'Create account' : 'Sign in';
    authSwitch.textContent = isRegister ? 'Sign in instead' : 'Create one';
    authToggle.firstChild.textContent = isRegister ? 'Already have an account? ' : "Don't have an account? ";
    authError.style.display = 'none';
  });

  authForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    authError.style.display = 'none';
    const username = authUsername.value.trim();
    const password = authPassword.value;
    if (!username || !password) return;

    authSubmit.disabled = true;
    authSubmit.innerHTML = '<span class="spinner"></span>';
    try {
      const endpoint = isRegister ? '/auth/register' : '/auth/login';
      const data = await api(endpoint, { method: 'POST', body: { username, password } });
      token = data.access_token;
      currentUser = username;
      localStorage.setItem(TOKEN_KEY, token);
      localStorage.setItem(USER_KEY, currentUser);
      showApp();
    } catch (err) {
      authError.textContent = err.message;
      authError.style.display = 'block';
    } finally {
      authSubmit.disabled = false;
      authSubmit.textContent = isRegister ? 'Create account' : 'Sign in';
    }
  });

  function logout() {
    token = null;
    currentUser = null;
    currentProject = null;
    currentChat = null;
    localStorage.removeItem(TOKEN_KEY);
    localStorage.removeItem(USER_KEY);
    if (pollInterval) clearInterval(pollInterval);
    showAuth();
  }

  logoutBtn.addEventListener('click', logout);

  // -- Projects --
  async function loadProjects() {
    try {
      projects = await api('/projects');
      renderProjects();
    } catch (err) {
      toast(err.message, 'error');
    }
  }

  function renderProjects() {
    projectList.innerHTML = '';
    if (projects.length === 0) {
      projectList.innerHTML = '<div class="empty-state" style="padding:24px 12px;font-size:13px;">No projects yet</div>';
      return;
    }
    projects.forEach(p => {
      const el = document.createElement('div');
      el.className = 'project-item' + (currentProject && currentProject.id === p.id ? ' active' : '');
      el.innerHTML = '<span class="dot"></span>' + escapeHtml(p.name);
      el.addEventListener('click', () => selectProject(p));
      projectList.appendChild(el);
    });
  }

  function selectProject(p) {
    currentProject = p;
    currentChat = null;
    renderProjects();
    noProject.style.display = 'none';
    projectView.style.display = 'flex';
    projectView.classList.remove('hidden');
    projectTitle.textContent = p.name;
    projectDesc.textContent = p.description || '';

    // Reset to files tab
    activateTab('files');

    loadFiles();
    loadChats();
    loadArtifacts();

    // Poll for status updates
    if (pollInterval) clearInterval(pollInterval);
    pollInterval = setInterval(() => {
      loadFiles();
      loadArtifacts();
    }, 8000);
  }

  newProjectBtn.addEventListener('click', () => {
    projectModal.classList.add('active');
    $('#projectName').value = '';
    $('#projectDescription').value = '';
    $('#projectName').focus();
  });

  projectModalCancel.addEventListener('click', () => projectModal.classList.remove('active'));
  projectModal.addEventListener('click', (e) => {
    if (e.target === projectModal) projectModal.classList.remove('active');
  });

  projectForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = $('#projectName').value.trim();
    const description = $('#projectDescription').value.trim();
    if (!name) return;
    try {
      const p = await api('/projects', { method: 'POST', body: { name, description } });
      projectModal.classList.remove('active');
      projects.unshift(p);
      selectProject(p);
    } catch (err) {
      toast(err.message, 'error');
    }
  });

  // -- Tabs --
  function activateTab(name) {
    $$('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === name));
    $$('.tab-content').forEach(tc => tc.classList.toggle('active', tc.id === 'tab-' + name));
  }

  $$('.tab').forEach(t => t.addEventListener('click', () => activateTab(t.dataset.tab)));

  // -- Files --
  async function loadFiles() {
    if (!currentProject) return;
    try {
      const files = await api('/projects/' + currentProject.id + '/files');
      renderFiles(files);
    } catch (err) { /* silent */ }
  }

  function renderFiles(files) {
    if (files.length === 0) {
      fileList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">&#128196;</div>No files uploaded yet</div>';
      return;
    }
    fileList.innerHTML = '';
    files.forEach(f => {
      const el = document.createElement('div');
      el.className = 'file-item';
      el.innerHTML = `
        <div class="file-icon ${extClass(f.extension)}">${f.extension.replace('.','').toUpperCase()}</div>
        <div class="file-info">
          <div class="file-name">${escapeHtml(f.original_name)}</div>
          <div class="file-meta">
            <span>${formatBytes(f.size_bytes)}</span>
            <span>${formatDate(f.created_at)}</span>
          </div>
        </div>
        <span class="file-status ${f.status}">${f.status}</span>
        <button class="file-delete" data-id="${f.id}" title="Delete">&times;</button>
      `;
      el.querySelector('.file-delete').addEventListener('click', () => deleteFile(f.id));
      fileList.appendChild(el);
    });
  }

  async function deleteFile(id) {
    if (!confirm('Delete this file?')) return;
    try {
      await api('/projects/' + currentProject.id + '/files/' + id, { method: 'DELETE' });
      loadFiles();
    } catch (err) {
      toast(err.message, 'error');
    }
  }

  // Drag & drop
  dropZone.addEventListener('click', () => fileInput.click());
  dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
  dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
  dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('drag-over');
    uploadFiles(e.dataTransfer.files);
  });
  fileInput.addEventListener('change', () => {
    uploadFiles(fileInput.files);
    fileInput.value = '';
  });

  async function uploadFiles(files) {
    for (const file of files) {
      try {
        const fd = new FormData();
        fd.append('file', file);
        await api('/projects/' + currentProject.id + '/files', { method: 'POST', body: fd });
        toast('Uploaded ' + file.name, 'success');
      } catch (err) {
        toast('Upload failed: ' + err.message, 'error');
      }
    }
    loadFiles();
  }

  // -- Chat --
  async function loadChats() {
    if (!currentProject) return;
    try {
      chats = await api('/projects/' + currentProject.id + '/chats');
      renderChatSelect();
    } catch (err) { /* silent */ }
  }

  function renderChatSelect() {
    chatSelect.innerHTML = '<option value="">Select a conversation...</option>';
    chats.forEach((c, i) => {
      const opt = document.createElement('option');
      opt.value = c.id;
      opt.textContent = 'Chat ' + (chats.length - i) + ' - ' + formatDate(c.created_at);
      if (currentChat && currentChat.id === c.id) opt.selected = true;
      chatSelect.appendChild(opt);
    });
  }

  chatSelect.addEventListener('change', () => {
    const id = chatSelect.value;
    if (!id) {
      currentChat = null;
      chatMessages.innerHTML = '';
      chatEmpty.style.display = 'flex';
      return;
    }
    currentChat = chats.find(c => c.id === id) || null;
    loadMessages();
  });

  newChatBtn.addEventListener('click', async () => {
    if (!currentProject) return;
    try {
      const chat = await api('/projects/' + currentProject.id + '/chats', { method: 'POST' });
      chats.unshift(chat);
      currentChat = chat;
      renderChatSelect();
      chatMessages.innerHTML = '';
      chatEmpty.style.display = 'flex';
    } catch (err) {
      toast(err.message, 'error');
    }
  });

  async function loadMessages() {
    if (!currentProject || !currentChat) return;
    try {
      const msgs = await api('/projects/' + currentProject.id + '/chats/' + currentChat.id + '/messages');
      renderMessages(msgs);
    } catch (err) {
      toast(err.message, 'error');
    }
  }

  function renderMessages(msgs) {
    chatMessages.innerHTML = '';
    if (msgs.length === 0) {
      chatEmpty.style.display = 'flex';
      chatMessages.appendChild(chatEmpty);
      return;
    }
    chatEmpty.style.display = 'none';
    msgs.forEach(m => appendMessage(m));
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  function appendMessage(m) {
    chatEmpty.style.display = 'none';
    const el = document.createElement('div');
    el.className = 'msg ' + m.role;
    let html = escapeHtml(m.content);
    if (m.role === 'assistant' && m.citations && m.citations.length > 0) {
      html += '<div class="msg-citations">';
      m.citations.forEach(c => {
        html += `<div class="citation">
          <div class="citation-file">${escapeHtml(c.file_name)}</div>
          <div class="citation-text">${escapeHtml(c.chunk_text)}</div>
        </div>`;
      });
      html += '</div>';
    }
    el.innerHTML = html;
    chatMessages.appendChild(el);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  async function sendMessage() {
    const content = chatInput.value.trim();
    if (!content || !currentProject) return;

    // Auto-create chat if none selected
    if (!currentChat) {
      try {
        const chat = await api('/projects/' + currentProject.id + '/chats', { method: 'POST' });
        chats.unshift(chat);
        currentChat = chat;
        renderChatSelect();
      } catch (err) {
        toast(err.message, 'error');
        return;
      }
    }

    chatInput.value = '';
    chatInput.style.height = 'auto';
    appendMessage({ role: 'user', content, citations: null });

    typingIndicator.style.display = 'block';
    chatMessages.scrollTop = chatMessages.scrollHeight;
    chatSend.disabled = true;

    try {
      const resp = await api('/projects/' + currentProject.id + '/chats/' + currentChat.id + '/messages', {
        method: 'POST',
        body: { content },
      });
      typingIndicator.style.display = 'none';
      appendMessage(resp);
    } catch (err) {
      typingIndicator.style.display = 'none';
      toast(err.message, 'error');
    } finally {
      chatSend.disabled = false;
    }
  }

  chatSend.addEventListener('click', sendMessage);
  chatInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  // Auto-resize chat input
  chatInput.addEventListener('input', () => {
    chatInput.style.height = 'auto';
    chatInput.style.height = Math.min(chatInput.scrollHeight, 150) + 'px';
  });

  // -- PPT --
  pptForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!currentProject) return;

    const topic = $('#pptTopic').value.trim();
    const audience = $('#pptAudience').value.trim() || 'general';
    const num_slides = parseInt($('#pptSlides').value) || 8;
    const style = $('#pptStyle').value;

    if (!topic) return;

    pptSubmit.disabled = true;
    pptSubmit.innerHTML = '<span class="spinner"></span> Generating...';

    try {
      await api('/projects/' + currentProject.id + '/ppt', {
        method: 'POST',
        body: { topic, audience, num_slides, style },
      });
      toast('Presentation queued', 'success');
      $('#pptTopic').value = '';
      loadArtifacts();
    } catch (err) {
      toast(err.message, 'error');
    } finally {
      pptSubmit.disabled = false;
      pptSubmit.textContent = 'Generate PPTX';
    }
  });

  async function loadArtifacts() {
    if (!currentProject) return;
    try {
      const artifacts = await api('/projects/' + currentProject.id + '/artifacts');
      renderArtifacts(artifacts);
    } catch (err) { /* silent */ }
  }

  function renderArtifacts(artifacts) {
    if (artifacts.length === 0) {
      artifactList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">&#128202;</div>No presentations generated yet</div>';
      return;
    }
    artifactList.innerHTML = '';
    artifacts.forEach(a => {
      const meta = a.metadata_json || {};
      const el = document.createElement('div');
      el.className = 'artifact-item';
      el.innerHTML = `
        <div class="artifact-icon">PPTX</div>
        <div class="artifact-info">
          <div class="artifact-topic">${escapeHtml(meta.topic || 'Presentation')}</div>
          <div class="artifact-meta">
            <span>${meta.num_slides || '?'} slides</span>
            <span>${escapeHtml(meta.style || '')}</span>
            <span class="file-status ${a.status}">${a.status}</span>
            <span>${formatDate(a.created_at)}</span>
          </div>
        </div>
        ${a.status === 'ready' ? '<a href="' + API + '/artifacts/' + a.id + '/download" class="btn btn-primary artifact-download" target="_blank">Download</a>' : ''}
      `;
      artifactList.appendChild(el);
    });
  }

  // -- Escape HTML --
  function escapeHtml(str) {
    if (!str) return '';
    const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
    return str.replace(/[&<>"']/g, c => map[c]);
  }

  // -- Init --
  if (token) {
    showApp();
  } else {
    showAuth();
  }
})();
</script>
</body>
</html>
